#!/usr/bin/env python
"""
Signal Sciences CLI Tool

API credentials must be exported to environment variables:
export SIGSCI_EMAIL=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
export SIGSCI_PASSWORD=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
export SIGSCI_CORP=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
export SIGSCI_SITE=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
"""

from __future__ import print_function
import os
import sys
import json
import argparse
from pysigsci import sigsciapi


def print_json_data(json_data, pretty=False):
    """
    Print JSON data, with option of pretty printing
    """
    if pretty:
        print(json.dumps(json_data, indent=4))
    else:
        print(json.dumps(json_data))


def main():
    """
    Main function for Signal Sciences CLI tool
    """
    try:
        email = os.environ["SIGSCI_EMAIL"]
        password = os.environ["SIGSCI_PASSWORD"]

    except KeyError as error:
        print("Environment variable not set {}".format(str(error)))
        sys.exit()

    # Create sigsciapi object
    sigsci = sigsciapi.SigSciApi(email, password)

    if 'message' in sigsci.token and 'Unauthorized' in sigsci.token['message']:
        print(sigsci.token['message'])
        sys.exit()

    if "SIGSCI_CORP" in os.environ:
        sigsci.corp = os.environ['SIGSCI_CORP']
    else:
        print('SIGSCI_CORP required.')
        sys.exit()

    if "SIGSCI_SITE" in os.environ:
        sigsci.site = os.environ['SIGSCI_SITE']
    else:
        print('SIGSCI_SITE required.')
        sys.exit()

    # Parse arguments
    parser = argparse.ArgumentParser(
        description="Process command line arguments.")

    parser.add_argument(
        '--get',
        help='Get data from the API.',
        choices=['corps', 'corp', 'corp-users', 'corp-user', 'overview-report',
                 'corp-sites', 'corp-site', 'custom-alerts', 'custom-alert',
                 'events', 'event', 'requests', 'request', 'request-feed',
                 'whitelist', 'blacklist', 'redactions', 'integrations',
                 'integration',
                 'parameter-whitelist', 'path-whitelist', 'activity',
                 'header-links', 'site-members', 'site-monitor', 'agents',
                 'suspicious-ips', 'top-attacks', 'timeseries-requests'])
    parser.add_argument(
        '--add',
        help='Add data via the API.',
        choices=['custom-alert', 'whitelist', 'blacklist',
                 'redaction', 'integration', 'parameter-whitelst',
                 'path-whitelist', 'header-links'])
    parser.add_argument(
        '--update',
        help='Update data via the API.',
        choices=['corp', 'corp-site', 'custom-alert', 'integration'])
    parser.add_argument(
        '--delete',
        help='Delete data via the API.',
        choices=['corp-user', 'custom-alert', 'whitelist', 'blacklist',
                 'redaction', 'integration', 'parameter-whitelst',
                 'path-whitelist', 'header-links', 'site-member'])
    parser.add_argument(
        '--from-time',
        help='From timestamp.')
    parser.add_argument(
        '--until-time',
        help='Until timestamp.')
    parser.add_argument(
        '--tag',
        help='Filter based on tag.')
    parser.add_argument(
        '--query',
        help='Search query.')
    parser.add_argument(
        '--data',
        help='Request data in JSON format.')
    parser.add_argument(
        '--email',
        help='Corp user email address.')
    parser.add_argument(
        '--field',
        help='Field specified for redactions.')
    parser.add_argument(
        '--site',
        help='Corp site short name.')
    parser.add_argument(
        '--id',
        help='Record identfier.')
    parser.add_argument(
        '--pretty',
        help='Print JSON in pretty format.',
        default=False,
        action="store_true")

    args = parser.parse_args()

    if args.get or args.add:
        try:
            if args.get:
                method = getattr(sigsci, 'get_' + args.get.replace("-", "_"))
            elif args.add:
                method = getattr(sigsci, 'add_' + args.add.replace("-", "_"))

        except AttributeError as error:
            print(str(error))

        else:
            try:
                params = dict()
                identifier = None

                if args.from_time:
                    params['from'] = args.from_time

                if args.until_time:
                    params['until'] = args.until_time

                if args.tag:
                    params['tag'] = args.tag

                if args.query:
                    params['q'] = args.query

                if args.data:
                    data = args.data

                if args.email:
                    identifier = args.email

                if args.field:
                    identifier = args.field

                if args.site:
                    identifier = args.site

                if args.id:
                    identifier = args.id

                num_params = len(params)

                if num_params > 0:
                    print_json_data(method(parameters=params), args.pretty)
                elif args.data:
                    print_json_data(method(data=data), args.pretty)
                else:
                    if identifier is not None:
                        print_json_data(method(identifier), args.pretty)
                    else:
                        print_json_data(method(), args.pretty)

            except Exception as error:
                print(str(error))


if __name__ == '__main__':
    main()
